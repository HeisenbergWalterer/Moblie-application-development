# 青柠健康 产品说明文档

## 一、产品概述

**青柠健康（Qingning Health）** 是一款基于 AI 能力的健康助手应用，针对现代人饮食记录繁琐、健康数据分散、目标追踪困难等痛点，提供轻量化、智能化的解决方案。

### 核心价值

#### 解决的问题

1. **饮食记录门槛高**  
   传统方式需手动查表、称重、计算热量与营养成分，耗时且易放弃。用户拍照后，往往不知道吃了多少卡路里、多少克蛋白质。

2. **健康数据碎片化**  
   体重记录在秤、步数在手环、饮食在手写本或不同 App，无法形成完整视图，难以发现规律。

3. **缺乏个性化建议**  
   通用建议缺乏针对性；用户需要结合自身数据（近期饮食、运动、体重变化）获取可执行的改进方案，但缺少集成工具。

#### 价值主张

- **一键记录**：拍照即识别食物、估算营养，自动生成结构化记录，降低使用门槛
- **数据整合**：汇集饮食、体重、步数（HealthKit）于一体，形成统一健康档案
- **AI 教练**：基于近 7 天数据摘要，提供个性化对话式建议，助力目标达成

---

## 二、核心功能与技术实现

### 功能 1：AI 饮食识别（Vision + Text）

#### 功能描述
用户拍摄/选择食物照片后，系统自动识别食物种类、估算重量与营养成分（热量、蛋白质、脂肪、碳水化合物），生成可编辑的记录列表。同时支持单条文本估算模式：手动输入食物名称与克重，AI 快速返回营养数据。

#### 技术实现思路

**1. 视觉识别流程（LogViewModel + AIClient）**

- **图片预处理**：将 UIImage 转为 JPEG（压缩至 0.9 质量），再编码为 Base64 字符串，嵌入 OpenAI Vision API 兼容请求体。
  
  ```swift
  let base64 = (UIImage(data: data)?.jpegData(compressionQuality: 0.9) ?? data).base64EncodedString()
  ```

- **Prompt 工程**：System Message 明确要求：
  - 输出严格 JSON 对象，不附加任何解释文本
  - 宏量比例贴合食物类别（主食高碳水、肉类高蛋白、油脂高脂肪）
  - 满足能量守恒公式：`kcal ≈ protein*4 + carb*4 + fat*9`（允许 ±10% 偏差）
  - 无法精确时给出合理估算，不留空值

  User Message 包含图片 URL（Base64 Data URI）与文本指令，引导模型直接返回 JSON。

- **解析响应**：
  - 优先解析 `response.choices[0].message.content` 为 JSON 对象，提取 `items` 数组
  - 兜底方案：正则提取花括号块，再次解析 JSON（应对模型偶尔添加前后缀的情况）
  - 将解析结果映射为 `FoodItemModel` 数组，存储原始响应 JSON 用于溯源

- **并发控制**：使用 `@Published var isRecognizing` 防止重复请求；显示加载态提升用户体验。

**2. 文本估算流程（estimateForItem）**

- 针对单个食物项，构造简化 Prompt（不含图片），仅传递食物名称与克重
- 复用同一套 API 接口与 JSON Schema，快速返回营养估算
- 适用场景：用户自行添加食物、手动调整重量后重新计算

**3. 数据持久化（Core Data）**

- 识别成功后，将图片转为 Base64 存储在 `imagePath` 字段（或文件路径）
- 将 `aiRawJSON`、`items` 数组、餐次类型、时间戳一并保存为 `DietRecordModel`
- Repository 模式封装 Core Data 操作，ViewModel 不直接操作 NSManagedObject

#### 关键技术点

- **能量守恒校验**：确保 AI 返回的营养数据符合基本物理规律，避免"100g 鸡胸肉含 500 kcal 蛋白质"等低质输出
- **Prompt 鲁棒性**：通过多轮测试优化 System Message，减少模型幻觉和格式错误
- **兜底解析**：正则表达式 + 二次 JSON 解析，处理模型输出不规范的边界情况
- **图片压缩**：平衡识别精度与网络传输速度，0.9 质量已足够视觉模型识别

---

### 功能 2：健康数据趋势面板（HealthKit + Chart）

#### 功能描述
汇总近 7/14/30 天的体重变化曲线、热量摄入柱状图、步数统计，用可视化图表直观展示健康趋势，帮助用户发现规律（如"周末摄入偏高""周三步数最多"）。

#### 技术实现思路

**1. 数据源整合（DashboardViewModel）**

- **步数数据（HealthKit）**：
  - 请求 `HKQuantityType.stepCount` 读取权限
  - 使用 `HKStatisticsQuery` 按天查询累计步数，返回 `[StepStatModel]` 数组
  - 异步串行查询，避免阻塞主线程

  ```swift
  let stats: [StepStatModel] = []
  for i in stride(from: days - 1, through: 0, by: -1) {
      let d = cal.date(byAdding: .day, value: -i, to: Date())!
      let s = try await steps(for: d)
      stats.append(StepStatModel(date: cal.startOfDay(for: d), steps: s))
  }
  ```

- **热量数据（Core Data）**：
  - 从 `DietRepository` 按时间范围查询饮食记录
  - 按日期分组，累加每天所有食物项的 `kcal`，生成 `[(Date, Double)]` 字典
  - 排序后输出为柱状图数据源

- **体重数据（Core Data）**：
  - 从 `BodyRepository` 查询所有体重记录
  - 按日期去重（同一天多条记录取最新），生成 `[(Date, Double)]` 曲线数据

**2. 图表渲染（SwiftUI + Swift Charts）**

- **体重曲线**：
  ```swift
  Chart(weightTrend, id: \.0) { (date, weight) in
      LineMark(x: .value("日期", date), y: .value("体重", weight))
      PointMark(x: .value("日期", date), y: .value("体重", weight))
  }
  ```
  
- **热量柱状图**：
  ```swift
  Chart(kcalBars, id: \.0) { (date, kcal) in
      BarMark(x: .value("日期", date), y: .value("热量", kcal))
  }
  ```

- **步数列表**：
  使用 `LazyVStack` 展示每日步数，配合进度条（当前步数 / 目标步数）可视化达成率

**3. 趋势摘要（自然语言）**

- 计算首尾体重差值 `lastWeight - firstWeight`
- 计算平均步数 `sum(steps) / count`
- 拼接摘要文本："过去 N 天，体重变化 ±X kg，平均步数 Y"
- 未来可扩展：增加"趋势标签"（如"持续下降""波动较大"），提供更智能的洞察

#### 关键技术点

- **异步并发加载**：HealthKit 查询、Core Data 查询并发执行，使用 `async/await` 保持代码简洁
- **日期对齐**：所有数据按 `startOfDay(for:)` 对齐到零点，避免时区和时分秒干扰聚合
- **缓存优化**：ViewModel 持有 `@Published` 数据源，视图刷新时无需重新查询，切换周期时才重新 load
- **图表性能**：Charts 库对大数据集优化良好，但仍需控制查询范围（如最多 90 天），避免渲染卡顿

---

### 功能 3：AI 健康教练（Context-Aware Chat）

#### 功能描述
用户可与 AI 对话，咨询健康建议、食谱推荐、运动计划。开启"附带摘要"开关后，系统自动将近 7 天的饮食热量、平均步数、体重趋势等数据注入对话上下文，AI 基于真实数据给出个性化回答（如"你本周摄入偏高，建议减少晚餐碳水"）。

#### 技术实现思路

**1. 对话管理（ChatViewModel + ChatRepository）**

- **多线程支持**：每个对话线程（Thread）有独立 UUID，用户可创建新线程、切换历史线程、删除线程
- **分页加载**：默认加载最近 50 条消息，上拉时按 `before` 时间戳分页查询更早消息，避免内存溢出
- **Core Data 持久化**：每条消息存储 `role`（system/user/assistant）、`content`、`date`、`threadId`，支持历史回溯

**2. 健康摘要构建（buildSummary）**

- **数据汇总**：
  - 从 `DietRepository` 查询近 7 天所有记录，累加总热量
  - 从 `HealthKitService` 查询近 7 天步数，计算平均值
  - 从 `BodyRepository` 查询近 7 天体重/腰围，计算平均值

- **结构化输出**：
  ```swift
  struct HealthSummary: Codable {
      var totalKcal: Double
      var avgSteps: Int
      var avgWeight: Double?
      var avgWaist: Double?
      // 未来可扩展：minKcalPerDay, maxKcalPerDay, kcalTrend, stepsTrend, weightTrend
  }
  ```

- **注入 Prompt**：若用户开启 `attachSummary`，将摘要转为自然语言插入 System Message：
  ```
  "用户近 7 天摄入总热量 12500 kcal，平均步数 8500，平均体重 70 kg。
  请结合这些数据提供个性化建议。"
  ```

**3. 流式响应（可选扩展）**

- 当前实现为一次性返回完整响应
- 未来可接入 Server-Sent Events（SSE），使用 `URLSession` 的 `bytes(for:)` 逐块解析 `data:` 事件，实时更新 UI
- 使用 `@Published var streamingTick` 触发 SwiftUI 重绘，实现"打字机效果"

**4. 错误处理与回退**

- API 配置缺失时，直接在界面显示提示："未配置 API Host，请前往设置"
- 网络请求失败时，插入系统消息提示用户检查网络
- 使用 `do-catch` 捕获所有异常，确保 App 不崩溃

#### 关键技术点

- **上下文感知**：通过动态拼接用户健康数据，将通用 AI 模型转化为"个人教练"
- **隐私保护**：所有数据本地计算，仅将汇总摘要（非明细）发送给 API，减少隐私泄露风险
- **对话连贯性**：保留历史消息列表，模型可基于上下文理解"那我应该吃多少"等代词引用
- **异步架构**：使用 `async/await` + `@MainActor` 确保 UI 更新在主线程，数据查询在后台

---

## 三、技术架构总览

```
┌─────────────────────────────────────────────────────────┐
│                      SwiftUI Views                      │
│  (LogView / DashboardView / ChatView / HomeView 等)    │
└───────────────────┬─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────┐
│                   ViewModels (MVVM)                     │
│  (LogViewModel / DashboardViewModel / ChatViewModel)    │
│  - 业务逻辑、状态管理、异步任务编排                    │
└───────────────────┬─────────────────────────────────────┘
                    │
        ┌───────────┴───────────┬───────────────┐
        ▼                       ▼               ▼
┌──────────────┐      ┌──────────────┐  ┌──────────────┐
│ Repositories │      │  Services    │  │   Utilities  │
│  (Core Data) │      │ (AI/HealthKit)│  │ (Config/Store)│
└──────────────┘      └──────────────┘  └──────────────┘
        │                       │               │
        ▼                       ▼               ▼
┌──────────────┐      ┌──────────────┐  ┌──────────────┐
│ Core Data    │      │ API Endpoint │  │  Keychain    │
│ (SQLite)     │      │ (千问 API)   │  │  (API Key)   │
└──────────────┘      └──────────────┘  └──────────────┘
```

### 架构特点

1. **MVVM 模式**：View 无业务逻辑，ViewModel 持有 @Published 状态，Repository 封装数据访问
2. **依赖注入**：通过 `@Environment(\.managedObjectContext)` 传递 Core Data 上下文，便于测试
3. **协议抽象**：`AIClientProtocol` 定义接口契约，便于 Mock 和替换实现（如切换到本地模型）
4. **单向数据流**：View → ViewModel → Repository → Data，避免循环依赖

---

## 四、未来扩展方向

1. **运动记录模块**：支持记录力量训练、有氧运动，计算消耗热量，与饮食形成能量平衡闭环
2. **社区与挑战**：引入打卡、勋章、排行榜，增强用户粘性
3. **食谱推荐引擎**：基于用户口味偏好、营养缺口、冰箱食材，生成个性化菜谱
4. **Apple Watch 集成**：同步心率、静息代谢率，提供更精准的热量计算
5. **AI 模型本地化**：接入 Core ML，实现离线识别，减少 API 成本与隐私顾虑

---

## 五、总结

**青柠健康** 通过 **AI 视觉识别 + 多源数据整合 + 上下文感知对话** 三大核心能力，将复杂的健康管理流程简化为"拍照—查看—对话"三步，降低用户使用门槛的同时，提供专业级的营养分析与个性化建议。

- **技术亮点**：Prompt 工程保证识别准确性、异步并发提升性能、Core Data 保障数据安全
- **产品亮点**：零学习成本、数据可视化、AI 教练式交互
- **商业价值**：可扩展为健身工作室、营养师咨询平台的 SaaS 工具，或向 C 端用户提供增值服务（如专业食谱库、高级报告）

本文档为产品的技术实现提供了全景视图，便于团队协作、技术评审与未来迭代参考。
